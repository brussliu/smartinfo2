<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqls>
<sqls> 

<!-- sl:检索 -->
<sql id="selectdelivery">
  SELECT
	"納品NO" AS no,
	"納品名称" AS name,
	case
				when "ステータス" = '1.新　規' then 0
				when "ステータス" = '2.発送済' then "発送数量"
				when "ステータス" = '3.受領中' then "受領数量"
				when "ステータス" = '4.納品済' then "最終納品数量"
			end as number,
	"ステータス" AS state,
	to_char("登録日",'YYYY/MM/DD') AS logindate,
	to_char("発送日",'YYYY/MM/DD') AS senddate,
	to_char("受領日",'YYYY/MM/DD') AS receivedate,
	to_char("完了日",'YYYY/MM/DD')  AS completiondate,
	"AMZ-納品番号" AS amz1,
	"AMZ-納品名" AS amz2,
	"AMZ-納品プラン番号" AS amz3,
	"AMZ-納品先" AS amz4,
	"AMZ-SKU合計" AS amz5,
	"AMZ-商品合計数" AS amz6
  FROM
	"TRN_納品管理" 
  WHERE
	"店舗ID" = :shopid 
  ORDER BY
	"納品NO"
</sql>

<!-- sl:削除 -->
<sql id="deletedelivery" paramPrefix="!">
		delete
		from
			"TRN_納品管理"
		where
			"納品NO" = !no
			and
			"店舗ID"= !shopid	 
</sql>

<!-- sl：新规TRN_納品管理 -->
<sql id="insertdelivery" paramPrefix="!">
 INSERT into "TRN_納品管理" 
	("納品NO",
	"納品名称",
	"ステータス",
	"登録日",
	"店舗ID",
	"登録日時")
 VALUES(
	 !no,
	 !names,
	 '1.新　規',
	 now(),
	 !shopid,
	 now()
	)
</sql>

<!--更新TRN_納品管理  -->
<sql id="updatedelivery" paramPrefix="!">
 UPDATE 
		"TRN_納品管理" 
 SET 
		"納品名称"= !names,
		"数量"= !count,
		"金額"= !money,
		"更新日時"= now() 
 WHERE
	"店舗ID" = !shopid 
	and	"納品NO" = !no
</sql>


<!-- 通过納品NO检索 納品名称 -->
<sql id="seachName" paramPrefix="!">
 	SELECT
		"納品名称" as name
	FROM
		"TRN_納品管理"   
	WHERE
			"店舗ID" = !shopid 
		and	"納品NO" = !no
</sql>


<!-- sl：新规TRN_納品明细 -->
<sql id="insertdeliverydata" paramPrefix="!">
 INSERT into "TRN_納品明細" 
	("納品NO",
	"SKU番号",
	"ASIN番号",
	"数量",
	"店舗ID",
	"登録日時")
 VALUES(
	 !no,
	 !sku,
	 !asin,
	 !num,
	 !shopid,
	 now()
	)
</sql>

<!-- sl:删除TRN_納品明细 -->
<sql id="deleteDeliveryContent" paramPrefix="!">
 DELETE 
 FROM
		"TRN_納品明細" 
 WHERE
	 	"店舗ID" = !shopid 
 and	"納品NO" = !no
</sql>

<!--通过asin,sku检索  -->
<sql id="seachdeliverycontent" paramPrefix="!">
 SELECT 
  DISTINCT
 	 	A."商品管理番号" AS productno,
		A."分類１" AS sub1,
		A."分類２" AS sub2,
		A."ASIN番号" AS asin,
		A."SKU番号" AS sku,
		A."LABEL番号" AS label,
		B."FBA在庫" AS fba,
		B."LOCAL在庫" AS LOCAL,
		C."数量" AS NUMBER 
 FROM
		"TRN_納品明細" C
		LEFT JOIN  "MST_出品マスタ情報" A ON A."ASIN番号" = C."ASIN番号" 
	AND A."SKU番号" = C."SKU番号" 
 LEFT JOIN "MST_在庫情報" B ON C."ASIN番号" = B."ASIN番号" 
	AND C."SKU番号" = B."SKU番号"
	
 WHERE
			A."ASIN番号" IN (
		SELECT
			cc."ASIN番号" AS asin 
		FROM
			"TRN_納品明細" cc
			LEFT JOIN "TRN_納品管理" bb ON cc."納品NO" = bb."納品NO" 
			AND cc."店舗ID" = bb."店舗ID" 
		WHERE
			cc."店舗ID" = !shopid 
		AND cc."納品NO" = !no 
 ) AND
		A."SKU番号" IN 
			(SELECT 
			 cc."SKU番号" AS sku
		FROM
			"TRN_納品明細" cc
			LEFT JOIN "TRN_納品管理" bb ON cc."納品NO" = bb."納品NO" 
			AND cc."店舗ID" = bb."店舗ID" 
		WHERE
			cc."店舗ID" = !shopid 
			AND cc."納品NO" = !no 
	)
 ORDER BY   A."商品管理番号",A."分類１",A."分類２"

</sql>



<!--sl:更新MST_在庫情報-途中在庫_入庫数量减去数量   -->
<sql id="removeDeliveryFromShip" paramPrefix="!">
	UPDATE "MST_在庫情報" 
	SET "途中在庫_入庫" = "途中在庫_入庫" - TRN."数量",
		"更新日時"= now() 
	FROM "TRN_納品明細" AS TRN
	WHERE
		"MST_在庫情報"."ASIN番号" = TRN."ASIN番号" 
	and	"MST_在庫情報"."SKU番号" =  TRN."SKU番号"
	and TRN."納品NO" = !no
	and TRN."店舗ID" = !shopid
</sql>
<!--sl:更新MST_在庫情報-LOCAL在庫数量减去数量  -->
<sql id="removeDeliveryFromLocal" paramPrefix="!">
	UPDATE "MST_在庫情報" 
	SET "LOCAL在庫" = "LOCAL在庫" - TRN."数量",
		"更新日時"= now() 
	FROM "TRN_納品明細" AS TRN
	WHERE
		"MST_在庫情報"."ASIN番号" = TRN."ASIN番号" 
	and	"MST_在庫情報"."SKU番号" =  TRN."SKU番号"
	and TRN."納品NO" = !no
	and TRN."店舗ID" = !shopid
</sql>
<!--sl:更新MST_在庫情報-途中在庫_入庫数量加上数量  -->
<sql id="allocateDeliveryToShip" paramPrefix="!">
	UPDATE "MST_在庫情報"  
	SET "途中在庫_入庫" = "途中在庫_入庫" + TRN."数量",
		"更新日時"= now() 
	FROM "TRN_納品明細" AS TRN
	WHERE
		"MST_在庫情報"."ASIN番号" = TRN."ASIN番号" 
	and	"MST_在庫情報"."SKU番号" =  TRN."SKU番号"
	and TRN."納品NO" = !no
	and TRN."店舗ID" = !shopid
</sql>

<sql id="allocateDeliveryToLocal" paramPrefix="!">
	UPDATE "MST_在庫情報"  
	SET "LOCAL在庫" = "LOCAL在庫" + TRN."数量",
		"更新日時"= now() 
	FROM "TRN_納品明細" AS TRN
	WHERE
		"MST_在庫情報"."ASIN番号" = TRN."ASIN番号" 
	and	"MST_在庫情報"."SKU番号" =  TRN."SKU番号"
	and TRN."納品NO" = !no
	and TRN."店舗ID" = !shopid
</sql>



<!--更新ステータス为2.発送済  -->
<sql id="updatedelivery2" paramPrefix="!">
 UPDATE 
 	"TRN_納品管理" 
 	SET "ステータス" = '2.発送済' ,
	 "更新日時"= now(),
	 "発送数量"=!num
 WHERE
	"店舗ID" = !shopid 
	and	"納品NO" = !no
</sql>

<!--更新ステータス3.受領中  -->
<sql id="updatedelivery3" paramPrefix="!">
 UPDATE 
	"TRN_納品管理" 
	SET 
	"ステータス" = '3.受領中',
	 "更新日時"= now(),
	 "発送数量"="発送数量"-!num,
	 "受領数量"=!num
 WHERE
	"店舗ID" = !shopid 
	and	"納品NO" = !no
</sql>


<!--更新ステータス	4.納品済  -->
<sql id="updatedelivery4" paramPrefix="!">
 UPDATE 
	"TRN_納品管理" 
	SET 
	"ステータス" = '4.納品済',
	 "更新日時"= now(),
	 "受領数量"="受領数量"-!num,
	 "最終納品数量"=!num
 WHERE
	"店舗ID" = !shopid 
	and	"納品NO" = !no
</sql>
 

<!-- 受領完了 -->

<!-- sl:受領完了-更新途中在庫_入庫 -->
<sql id="updateDeliveryNum"> 
	UPDATE "MST_在庫情報"
 	SET 
	 "LOCAL在庫" = (
			CASE
			WHEN :acceptance &gt; TRN."受領数量"  AND TRN."数量" &lt;= TRN."受領数量" 
					THEN "LOCAL在庫" + TRN."受領数量" - :acceptance else "LOCAL在庫"
			WHEN :acceptance &gt; TRN."受領数量"   AND TRN."数量" &gt; TRN."受領数量" 
					THEN "LOCAL在庫" + TRN."受領数量" - :acceptance else "LOCAL在庫"
			WHEN TRN."数量" &gt; 0  AND  TRN."受領数量" = 0
					THEN "LOCAL在庫" - :acceptance else "LOCAL在庫"
		END  ) ,
	 "途中在庫_入庫" =
		  ( CASE  WHEN :acceptance &gt; TRN."受領数量"   AND TRN."数量" &gt; TRN."受領数量" 
			THEN  "途中在庫_入庫" + TRN."受領数量" - :acceptance else TRN."受領数量"
			 END ) ,
	 TRN."受領数量" =
		  ( CASE    WHEN :acceptance &gt; TRN."受領数量"  AND TRN."数量" &lt;= TRN."受領数量"
			THEN :acceptance else TRN."受領数量"
				  	WHEN :acceptance &gt; TRN."受領数量"   AND TRN."数量" &gt; TRN."受領数量" 
			THEN :acceptance else TRN."受領数量"
					WHEN TRN."数量" &gt; 0  AND  TRN."受領数量" = 0 AND :acceptance &gt; 0
			THEN :acceptance else TRN."受領数量"
			 END )  ,
	 TRN."更新日時" =
		  ( CASE    WHEN :acceptance &gt; TRN."受領数量"  AND TRN."数量" &lt;= TRN."受領数量"
			THEN now( ) else TRN."更新日時"
				  	WHEN :acceptance &gt; TRN."受領数量"   AND TRN."数量" &gt; TRN."受領数量" 
			THEN now( ) else TRN."更新日時"
					WHEN TRN."数量" &gt; 0  AND  TRN."受領数量" = 0 AND :acceptance &gt; 0
			THEN now( ) else TRN."更新日時"
			 END )  ,
	  "更新日時" =
		  ( CASE    WHEN :acceptance &gt; TRN."受領数量"  AND TRN."数量" &lt;= TRN."受領数量"
			THEN now( ) else  "更新日時"
				  	WHEN :acceptance &gt; TRN."受領数量"   AND TRN."数量" &gt; TRN."受領数量" 
			THEN now( ) else  "更新日時"
					WHEN TRN."数量" &gt; 0  AND  TRN."受領数量" = 0 AND :acceptance &gt; 0
			THEN now( ) else  "更新日時"
			 END ) 
		FROM
				"TRN_納品明細" TRN 
		WHERE
			TRN."ASIN番号" = :asin
		and TRN."ASIN番号" = :sku
		and	"MST_在庫情報"."ASIN番号" = TRN."ASIN番号" 
		and	"MST_在庫情報"."SKU番号" =  TRN."SKU番号"
		and TRN."納品NO" = !no
		and TRN."店舗ID" = !shopid
</sql>
<!-- sl:受領完了-更新纳品管理受領完了数量和状态-->
<sql id="updateReceiveCompleteNumber">
	UPDATE "TRN_納品管理"  
		SET 
		"完了日" = now(),
	  	"更新日時" = now(),
		"ステータス" = '4.納品済',
		"最終納品数量" = 
			( SELECT  sum(TRN2."受領数量") AS count
			from "TRN_納品明細" TRN2
			WHERE
				TRN2."店舗ID" = :shopid 
			and TRN2."納品NO" = :no
			) 
	WHERE 
		"店舗ID" = :shopid 
	AND
		"納品NO" = :no
</sql>

<!-- #####受領完了################### -->

<!-- receive受领中 -->

<!-- sl:新规amz -->
<sql id="updateDeliveryAmz1">
	UPDATE "TRN_納品管理"
		SET "AMZ-納品番号" = :info,
		"更新日時" = now()
	WHERE 
		"店舗ID" = :shopid 
	and
		"納品NO" = :col0
 
</sql>
<sql id="updateDeliveryAmz2">
	UPDATE "TRN_納品管理"
		SET "AMZ-納品名" = :info,
		"更新日時" = now()
	WHERE 
		"店舗ID" = :shopid 
	and
		"納品NO" = :col0
 
</sql>

<sql id="updateDeliveryAmz3">
	UPDATE "TRN_納品管理"
	 SET 
		"AMZ-納品プラン番号" = :info,
		"更新日時" = now()
	WHERE 
		"店舗ID" = :shopid 
	and
		"納品NO" = :col0
 
</sql>

<sql id="updateDeliveryAmz4">
 UPDATE "TRN_納品管理"
	SET 
		"AMZ-納品先" = :info,
		"更新日時" = now()
	WHERE 
		"店舗ID" = :shopid 
	and
		"納品NO" = :col0
 
</sql>

<sql id="updateDeliveryAmz5">
	UPDATE "TRN_納品管理"
		SET 
		"AMZ-SKU合計" = cast(:info as int),
		"更新日時" = now()
	WHERE 
		"店舗ID" = :shopid 
	AND
		"納品NO" = :col0

</sql>

<sql id="updateDeliveryAmz6">
	UPDATE "TRN_納品管理"
		SET "AMZ-商品合計数" = cast(:info as int),
		"更新日時" = now()
	WHERE 
		"店舗ID" = :shopid 
	AND
		"納品NO" = :col0

</sql>

<!-- sl:納品明細の受領数量を更新-->
<sql id="updateDeliveryConAcceptance">
	UPDATE "TRN_納品明細"
		SET "受領数量" = :acceptance,
		"更新日時" = now()
	WHERE 
		"SKU番号" = :sku
	AND
		"ASIN番号" = :asin
	AND 
		"納品NO" = :col0
	AND
		"店舗ID" = :shopid 

</sql>

<!-- sl:新规未录入的明细数据 -->
<sql id="insertAcceptanceDetail">
		INSERT INTO "TRN_納品明細"
		(
			"納品NO",
			"SKU番号",
			"ASIN番号", 
			"数量",
			"受領数量",
			"店舗ID",
			"登録日時"
		)
		VALUES (
			:col0,--"納品NO"
			:col1,--"SKU番号"
			:col2,--"ASIN番号"
			'0',--"数量"
			:col3, --"受領数量"
			:shopid,
			now()
		)
</sql>

<!-- sl:受領中-更新途中在庫_入庫 -->
<sql id="updateMSTDelveryAdd"> 
	UPDATE "MST_在庫情報"
 	SET "更新日時" = now( ),
	 "途中在庫_入庫" = (
			CASE
			WHEN TRN."数量" &gt; 0  AND TRN."数量" = TRN."受領数量" 
					THEN "途中在庫_入庫" - TRN."受領数量" else "途中在庫_入庫"
			WHEN TRN."数量" &gt; 0   AND TRN."数量" &lt; TRN."受領数量" 
					THEN "途中在庫_入庫" - TRN."数量" else "途中在庫_入庫"
			WHEN TRN."数量" &gt; 0  AND TRN."数量" &lt; TRN."受領数量" 
					THEN "途中在庫_入庫" - TRN."受領数量" else "途中在庫_入庫"
			WHEN TRN."数量" &gt; 0  AND TRN."数量" = TRN."受領数量"  AND TRN."受領数量" = 0 
					THEN "途中在庫_入庫" - TRN."受領数量"  else "途中在庫_入庫"
		END  ) ,
	 "LOCAL在庫" =
		  ( CASE   WHEN TRN."数量" = 0 AND TRN."受領数量" &gt; 0 
			THEN "LOCAL在庫" - TRN."受領数量" else "LOCAL在庫"
				   WHEN TRN."数量" &gt; 0  AND TRN."数量" &lt; TRN."受領数量" 
			THEN "LOCAL在庫" + TRN."数量" -TRN."受領数量"  else "LOCAL在庫"
			 END ) 
		FROM
				"TRN_納品明細" TRN 
		WHERE
			"MST_在庫情報"."ASIN番号" = TRN."ASIN番号" 
		and	"MST_在庫情報"."SKU番号" =  TRN."SKU番号"
		and TRN."納品NO" = :no
		and TRN."店舗ID" = :shopid
</sql>

<!-- sl:更新纳品管理受領数量-->
<sql id="updateReceiveNumber">
	UPDATE "TRN_納品管理"  
		SET 
		"受領日" = now(),
	  	"更新日時" = now(),
		"ステータス" = '3.受領中',
		"受領数量" = 
			( SELECT  sum(TRN2."受領数量") AS count
			from "TRN_納品明細" TRN2
			WHERE
				TRN2."店舗ID" = :shopid 
			and TRN2."納品NO" = :no
			) 
	WHERE 
		"店舗ID" = :shopid 
	AND
		"納品NO" = :no
</sql>

<!-- ############受領中#####################3 -->



<!-- sl:更新纳品管理発送数量-->
<sql id="updateDeliverySend">
	UPDATE "TRN_納品管理"  
		SET 
		"発送日" = now(),
		"ステータス" = '2.発送済',
	  	"更新日時" = now(),
		"発送数量" = 
			( SELECT  sum(TRN2."数量") AS count
			from "TRN_納品明細" TRN2
			WHERE
				TRN2."店舗ID" = :shopid 
			and TRN2."納品NO" = :no
			) 
	WHERE 
		 "店舗ID" = :shopid 
	AND
		 "納品NO" = :no
</sql>

<!-- sl:納品NOリンク押下 -->
<sql id="selectdelivery_excel" >
	select  
			a."商品種別" as type,
			a."商品管理番号" as pno,
			a."親子区分" as preproduct,	
			a."分類１" as sub1,
			a."分類２" as sub2,
			a."ASIN番号" as asin,
			a."SKU番号" as sku,
			a."LABEL番号" as label,
			a."商品名称" as productname,
			e."価格" as price,
			case
				when a."親子区分" = '親商品' then null
				when d."FBA在庫" != 0 then 'FBA'
				when d."FBA在庫" is null and d."FBM在庫" is null then '-'
				when d."FBA在庫" is null and d."FBM在庫" is not null then 'FBM'
				when d."FBA在庫" = 0 and d."FBM在庫" is null then 'FBA'
				when d."FBA在庫" = 0 and d."FBM在庫" = 0 then '-'
				when d."FBA在庫" = 0 and d."FBM在庫" != 0 then 'FBM'
			end as shippingway,
			d."FBA在庫" as fba,
			d."FBM在庫" as fbm,
			d."途中在庫_入庫" as put,	
			d."LOCAL在庫" as local,
			d."途中在庫_仕入" as purchase,
			case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) end as stockonsell,
			case when a."親子区分" = '親商品' then null else COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockprepare,
			case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) + COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockall,
			b."販売数量（直近３日間）" as selled3,
			b."販売数量（直近７日間）" as selled7, 
			b."販売数量（直近３０日間）" as selled30, 
			b."販売数量（直近６０日間）" as selled60, 
			b."販売数量（直近９０日間）" as selled90, 
			b."販売数量（直近１８０日間）" as selled180, 
			b."販売数量（直近３６０日間）" as selled360, 
			case when a."親子区分" = '親商品' then null else rpad(cast(round(b."販売数量（日平均値）", 5) as varchar), 5, '0') end as dayaverage,
			c."在庫販売可能日数" as stocknumber,
			c."保有数量販売可能日数" as salenumber,
			c."推奨納品数量" as deliveryquantity,
			c."推奨仕入数量" as purchasequantity,
			a."店舗ID" as shopid,
			a."暫定フラグ" as zt_flg,
			a.num as num
		from
			(select m.*,TRN."数量" num from "TRN_納品明細" TRN,"MST_出品マスタ情報" m  where TRN."店舗ID" = :shopid  AND TRN."納品NO" = :no AND m."ASIN番号"=TRN."ASIN番号" AND m."SKU番号" = TRN."SKU番号") a
			left join "MST_販売数量情報" b on a."ASIN番号" = b."ASIN番号" and a."SKU番号" = b."SKU番号" and a."店舗ID" = b."店舗ID"
			left join "MST_入庫仕入推奨数量情報" c on a."ASIN番号" = c."ASIN番号" and a."SKU番号" = c."SKU番号" and a."店舗ID" = c."店舗ID"
			left join "MST_在庫情報"  d on a."ASIN番号" = d."ASIN番号" and a."SKU番号" = d."SKU番号" and a."暫定フラグ" = d."暫定フラグ" and a."店舗ID" = d."店舗ID" 
			left join "IPT_全出品情報" e on a."ASIN番号" = e."ASIN 1" and a."SKU番号" = e."出品者SKU" and a."店舗ID" = e."店舗ID" 
			left join "MST_ソート情報" S1 on a."商品種別" = S1."商品種別" and S1."分類" = '分類１' and a."分類１" = S1."内容" and a."店舗ID" = S1."店舗ID"
			left join "MST_ソート情報" S2 on a."商品種別" = S2."商品種別" and S2."分類" = '分類２' and a."分類２" = S2."内容" and a."店舗ID" = S2."店舗ID"
		where
			a."暫定フラグ" = '0'
			and
			a."店舗ID" = :shopid
			and 
			a."親子区分" = '子商品'
		order by
			a."商品種別",
			a."商品管理番号",
			COALESCE(cast(S1."ソート" as varchar), a."分類１")
			,COALESCE(cast(S2."ソート" as varchar), a."分類２")
</sql>
 </sqls>

