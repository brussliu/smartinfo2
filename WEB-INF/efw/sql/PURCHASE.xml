<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqls>
<sqls> 

<!-- sl:检索 -->
<sql id="selectpurchase">
 SELECT
	"仕入NO" AS no,
	"仕入名称" AS name,
	"仕入区分" AS type,
	"数量" AS number,
	"金額" AS money,
	"ステータス" AS state,
	to_char("登録日",'YYYY/MM/DD') AS logindate,
	to_char("発送日①",'YYYY/MM/DD') AS senddate1,
	to_char("発送日②",'YYYY/MM/DD') AS senddate2,
	to_char("完了日",'YYYY/MM/DD')  AS completiondate,
	"発送方式" AS sendway,
	"商品費用" AS productamountrmb,
	"商品費用（円）" AS productamountry,
	"物流費用" AS shipamountrmb,
	"物流費用（円）" AS shipamountry,
	"税金" AS faxamountrmb,
	"税金（円）" AS faxamountry,
	"為替レート" AS rate,
	"合計" AS totalrmb,
	"合計（円）" AS totalry,
	"追跡番号" AS tracknumber 
 FROM
	"TRN_仕入管理" 
 WHERE
	"店舗ID" = :shopid 
 ORDER BY
	"仕入NO"
</sql>
<!-- sl:削除 -->
<sql id="deletepurchase" paramPrefix="!">
		delete
		from
			"TRN_仕入管理"
		where
			"仕入NO" = !no
			and
			"店舗ID"= !shopid	 
</sql>

<!-- sl：新规TRN_仕入管理 -->
<sql id="savepurchase" paramPrefix="!">
	INSERT into "TRN_仕入管理" 
		(
		"仕入NO",
		"仕入名称",
		"仕入区分",
		"数量",
		"金額",

		"ステータス",
		"登録日",
		"発送日①",
		"発送日②",

		"完了日",
		"発送方式",
		"為替レート",

		"商品費用",
		"商品費用（円）",
		"物流費用",
		"物流費用（円）",
		"税金",
		"税金（円）",
		"合計",
		"合計（円）",

		"店舗ID",
		"登録日時",
		"追跡番号" )
	VALUES(
		!no, --仕入NO
		!purchase, --仕入名称
		'A', --仕入区分
		!count, --数量
		!money, --金額
		'0:新規登録', --ステータス
		now(), --登録日
		to_timestamp(!forwarddate1,'yyyy-MM-dd hh24:mi:ss'), --発送日①
		to_timestamp(!forwarddate2,'yyyy-MM-dd hh24:mi:ss'), --発送日②

		to_timestamp(!completiondate,'yyyy-MM-dd hh24:mi:ss'), --完了日
		!ship, --発送方式
		cast(!rate as numeric), --為替レート

		cast(!productamountRMB as numeric), --商品費用
		cast(SUBSTRING (!productamountRY,1,4) as numeric), --商品費用（円）
		cast(!shipamountRMB as numeric), --物流費用
		cast(SUBSTRING (!shipamountRY,1,4) as numeric), --物流費用（円）
		cast(!faxamountRMB as numeric), --税金
		cast(SUBSTRING (!faxamountRY,1,4) as numeric), --税金（円）
		cast(!totalRMB as numeric), --合計
		cast(!totalRY as numeric), --合計（円）

		!shopid, --店舗ID
		now(), --登録日時
		!track --追跡番号
	)
</sql>



<!-- sl:新规TRN_仕入明細 -->
<sql id="insertpurchasedata" paramPrefix="!">
 INSERT into "TRN_仕入明細" 
	("仕入NO",
	"SKU番号",
	"ASIN番号",

	"商品管理番号",
	"商品種別",
	"分類１",

	"分類２",
	"単価",
	"数量",
	"金額",
	"店舗ID",
	"登録日時")
 VALUES(
	 !no,
	 !sku,
	 !asin,

	 !productno,
	 !type,
	 !sub1,

	 !sub2,
	 !price,
	 !num,
	 (cast(!price as numeric(10,2))*cast(!num as int)),
	 !shopid,
	 now()
	)
</sql>

<!--sl:通过ASIN番号，SKU番号查商品,获取价格  -->
<sql id="searchProductAS" paramPrefix="!">
 SELECT 
	"仕入価格" as price
 FROM
	"MST_出品マスタ情報" 
 WHERE
  "店舗ID" = !shopid 
  	    <if exists="asin"> AND (	
		  "ASIN番号" = !asin
		)
	    </if>
	 	<if exists="sku"> AND (	
		  "SKU番号" = !sku
		)
	    </if> 

</sql>

<!-- sl:通过暂定数据查商品,获取价格  -->
<sql id="searchProduct" paramPrefix="!">
 SELECT 
	"仕入価格" as price
 FROM
	"MST_出品マスタ情報" 
 WHERE
  "店舗ID" = !shopid 
  	    <if exists="no"> AND (	
		  "商品管理番号" = !no
		)
	    </if>
	 	<if exists="type"> AND (	
		  "商品種別" = !type
		)
	    </if> 
	 	<if exists="sub1"> AND (	
		  "分類１" = !sub1
		)
	    </if>
	    <if exists="sub2"> AND (	
		  "分類２" = !sub2
		)
	    </if>
</sql>

<!-- sl:统计数量，金额 -->
<sql id="countNumberAndMoney" paramPrefix="!">
 SELECT 
 	sum("数量") AS count,
 	sum("金額") AS money 
 from "TRN_仕入明細"
 	WHERE
  	"店舗ID" = !shopid 
 and "仕入NO" = !purchaseno
</sql>



<!-- sl: 新规TRN_仕入資料-->
<sql id="savepurchasefile" paramPrefix="!">
	 INSERT into "TRN_仕入資料" (
		 "仕入NO",
		 "枝番",
		 "ファイル名称",
		 "資料名称",
		 "拡張子",
		 "店舗ID",
		 "登録日時"
	 ) VALUES(
	 !purchaseno,
	 cast(!maxno as int),
	 !filename,
	 !dataname,
	 !suffix,
	 !shopid,
	 now()
	 )
</sql>

<!-- sl:查询最大枝番  -->
<sql id="queryPurchaseData" paramPrefix="!">
 SELECT 
 	"max"("枝番") as maxno
 FROM 
	  "TRN_仕入資料" 
 WHERE
 	"店舗ID" = !shopid 
  	<if exists="purchaseno"> AND (	
		  "仕入NO" = !purchaseno
		)
	</if>
</sql>
 	
<!-- sl:查询TRN_仕入資料所有文件  -->
<sql id="queryPurchaseFile" paramPrefix="!">
 SELECT 
	"資料名称" as dataname,
	"拡張子" as suffix
 FROM
	"TRN_仕入資料" 
 WHERE
  "店舗ID" = !shopid 
	<if exists="purchaseno"> AND (	
		"仕入NO" = !purchaseno
	)
	</if>
	<if notexists="purchaseno"> AND (	
		"仕入NO" is null
	)
	</if>
	    
</sql>

<!-- sl:删除TRN_仕入資料文件 -->
<sql id="deletePurchaseFile" paramPrefix="!">
		delete
		from
			"TRN_仕入資料"
		where
			"店舗ID"= !shopid	
		<if exists="purchaseno"> AND (	
		"仕入NO" = !purchaseno
 			)
		</if>
		<if notexists="purchaseno"> AND (	
		"仕入NO" is null
		 )
		</if> 
			<if exists="dataname"> AND (	
		"資料名称" = !dataname
			)
		</if>
		<if notexists="dataname"> AND (	
		"資料名称" is null
			)
			</if>
</sql>

<!-- sl:根据TRN_仕入資料资料名查询文件  -->
<sql id="queryPurchaseFileForDataname" paramPrefix="!">
 SELECT 
	"ファイル名称" as files,
	"拡張子" as suffix
 FROM
	"TRN_仕入資料" 
 WHERE
  "店舗ID" = !shopid 
	<if exists="purchaseno"> AND (	
		"仕入NO" = !purchaseno
	)
	</if>
	<if notexists="purchaseno"> AND (	
		"仕入NO" is null
	)
	</if>
	  	<if exists="dataname"> AND (	
		"資料名称" = !dataname
	)
	</if>
	<if notexists="dataname"> AND (	
		"資料名称" is null
	)
	</if>  
</sql>

 </sqls>

