<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqls>
<sqls>
<!-- sl：检索商品分类 -->
<sql id="searchproducttype">
 SELECT DISTINCT
	"商品種別" as value,
	substr("商品種別",4) as text
 FROM
	"MST_出品マスタ情報" 
 WHERE
	"length" ( 商品種別 ) > 0 
	AND "店舗ID" = :shopId 
 ORDER BY
	"商品種別"
	</sql>
<!-- sl：检索商品番号 -->
<sql id="searchproducno">
 SELECT DISTINCT
	"商品管理番号" AS value,
	"商品管理番号" AS text 
  FROM
	"MST_出品マスタ情報" 
 WHERE
	"length" ( 商品管理番号 ) > 0 
	AND "店舗ID" = :shopId  
 ORDER BY
	"商品管理番号"
</sql>
<!-- sl：检索商品总结 -->
<sql id="selectstockinfo" >
 select
	a."商品種別" as type,
	a."商品管理番号" as no,
	a."親子区分" as preproduct,	
	a."分類１" as sub1,
	a."分類２" as sub2,
	a."ASIN番号" as asin,
	a."SKU番号" as sku,
	a."LABEL番号" as label,
	a."商品名称" as productname,
	
 CASE
	WHEN (d."FBA在庫" IS NULL OR d."FBA在庫" = 0 ) AND (d."FBM在庫" IS NULL OR d."FBM在庫" = 0 )THEN NULL
	WHEN ( d."FBM在庫" IS NULL OR d."FBM在庫" = 0 )AND ( d."FBA在庫" != 0 AND d."FBA在庫" IS NOT NULL) THEN 'FBA'
	WHEN  (d."FBA在庫" IS NULL OR d."FBA在庫" = 0) AND (d."FBM在庫" != 0 AND d."FBM在庫" IS NOT NULL ) THEN 'FBM'
	ELSE ''
 END  AS send ,
	d."FBA在庫" as fba,
	d."FBM在庫" as fbm,
	d."途中在庫_入庫" as put,	
	d."LOCAL在庫" as local,
	d."途中在庫_仕入" as purchase,
	
 ((CASE 
	WHEN d."FBA在庫" is null THEN 0
	ELSE CAST(d."FBA在庫" as int4) END)+
 (CASE 
	WHEN d."FBM在庫" is null THEN 0
	ELSE CAST(d."FBM在庫" as int4) END)+
 (CASE 
	WHEN d."途中在庫_入庫" is null THEN 0
	ELSE CAST(d."途中在庫_入庫" as int4) END)) as stockonsell,

 ((CASE 
	WHEN d."LOCAL在庫" is null THEN 0
	ELSE CAST(d."LOCAL在庫" as int4) END)+
 (CASE 
	WHEN d."途中在庫_仕入" is null THEN 0
	ELSE CAST(d."途中在庫_仕入" as int4) END)) as stockprepare,

 ((CASE WHEN d."FBA在庫" is null THEN 0
	ELSE CAST(d."FBA在庫" as int4) END)+
 (CASE  WHEN d."FBM在庫" is null THEN 0
	ELSE CAST(d."FBM在庫" as int4) END)+
 (CASE  WHEN d."途中在庫_入庫" is null THEN 0
	ELSE CAST(d."途中在庫_入庫" as int4) END)+
 (CASE  WHEN d."LOCAL在庫" is null THEN 0
	ELSE CAST(d."LOCAL在庫" as int4) END)+
 (CASE  WHEN d."途中在庫_仕入" is null THEN 0
	ELSE CAST(d."途中在庫_仕入" as int4)  END)) as stockall,
	
	
 lpad((CASE  WHEN "販売数量（直近３日間）" is null THEN '0'
	ELSE CAST("販売数量（直近３日間）" as VARCHAR) 
	END), 3, '0')  as selled3, 
 lpad(	(CASE  WHEN "販売数量（直近７日間）" is null THEN '0'
	ELSE CAST("販売数量（直近７日間）" as VARCHAR) 
	END), 3, '0')  as selled7,
 lpad(	(CASE  WHEN "販売数量（直近３０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近３０日間）" as VARCHAR) 
	END), 3, '0')  as selled30,
 lpad(	(CASE  WHEN "販売数量（直近６０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近６０日間）" as VARCHAR) 
	END), 3, '0')  as selled60,
 lpad(	(CASE  WHEN "販売数量（直近９０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近９０日間）" as VARCHAR) 
	END), 3, '0')  as selled90,
 lpad(	(CASE  WHEN "販売数量（直近１８０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近１８０日間）" as VARCHAR) 
	END), 3, '0')  as selled180,
 lpad(	(CASE  WHEN "販売数量（直近３６０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近３６０日間）" as VARCHAR) 
	END), 3, '0')  as selled360,
	
  round((((CASE  WHEN "販売数量（直近３日間）" is null THEN 0
	ELSE CAST("販売数量（直近３日間）" as int4) END) * 0.05)+
	((CASE  WHEN "販売数量（直近７日間）" is null THEN 0
	ELSE CAST("販売数量（直近７日間）" as int4) END) * 0.05)+
	((CASE  WHEN "販売数量（直近３０日間）" is null THEN 0
	ELSE CAST("販売数量（直近３０日間）" as int4) END) * 0.1)+
	((CASE  WHEN "販売数量（直近６０日間）" is null THEN 0
	ELSE CAST("販売数量（直近６０日間）" as int4) END) * 0.3)+
	((CASE  WHEN "販売数量（直近９０日間）" is null THEN 0
	ELSE CAST("販売数量（直近９０日間）" as int4) END) * 0.3)+
	((CASE  WHEN "販売数量（直近１８０日間）" is null THEN 0
	ELSE CAST("販売数量（直近１８０日間）" as int4) END) * 0.1)+
	((CASE  WHEN "販売数量（直近３６０日間）" is null THEN 0
	ELSE CAST("販売数量（直近３６０日間）" as int4) END) * 0.1) ),2 ) AS dayaverage,

	c."在庫販売可能日数" as stocknumber,
	c."保有数量販売可能日数" as salenumber,	
	c."推奨納品数量" as deliveryquantity,
	c."推奨仕入数量" as purchasequantity
 from
	"MST_出品マスタ情報" a
	left join "MST_販売数量情報" b on a."ASIN番号"=b."ASIN番号"and a."SKU番号"=b."SKU番号"
	left join "MST_入庫仕入推奨数量情報" c on a ."ASIN番号"=c."ASIN番号"and a."SKU番号"=c."SKU番号"
    left join "MST_在庫情報"  d on a."ASIN番号"=d."ASIN番号"and a."SKU番号"=d."SKU番号"
	WHERE
			1=1
 	<if exists="opt_productno"> AND (
				<if istrue="opt_productno == 'マスタ未登録'"> A."商品管理番号" is NULL </if>
				<if istrue="opt_productno != 'マスタ未登録'"> A."商品管理番号" = :opt_productno </if>
			    )
	</if>

	<if exists="text_keyword"> AND (
		UPPER(A."商品種別") LIKE concat('%', :text_keyword ,'%') OR
		UPPER(A."商品管理番号") LIKE concat('%', :text_keyword ,'%') OR
		UPPER(A."親子区分") LIKE concat('%', :text_keyword ,'%') OR

		UPPER(A."分類１") LIKE concat('%', :text_keyword ,'%') OR
		UPPER(A."分類２") LIKE concat('%', :text_keyword ,'%') OR
		UPPER(A."SKU番号") LIKE concat('%', :text_keyword ,'%') OR

		UPPER(A."ASIN番号") LIKE concat('%', :text_keyword ,'%') OR
		UPPER(A."LABEL番号") LIKE concat('%', :text_keyword ,'%')OR
		UPPER(A."商品名称") LIKE concat('%', :text_keyword ,'%')
			    )
		</if>

	 <if exists="ptype"> AND (	
		  A."商品種別" IN (@ptype)
		)
	 </if>

	<if exists="sendArr">	AND (
		 ( d."FBA在庫" != 0 AND d."FBA在庫" IS NOT NULL) OR (  d."FBM在庫" != 0 AND d."FBM在庫" IS NOT NULL)
	  )
	</if>
	<if notexists="sendArr">  	
		 <if exists="send">	
			 <if istrue='send1 =="FBA"'> AND ( ( d."FBM在庫" IS NULL OR d."FBM在庫" = 0 )AND  ( d."FBA在庫" != 0 AND d."FBA在庫" IS NOT NULL) )  </if>
			<if istrue='send1 =="FBM"'> AND (( d."FBA在庫" IS NULL OR d."FBA在庫" = 0 )AND (d."FBM在庫" != 0 AND d."FBM在庫" IS NOT NULL ) ) </if>
		  </if>
	</if>
		AND A."店舗ID" = :shopid  
	ORDER BY
			A."商品種別",
			A."商品管理番号",
			A."親子区分",
			A."分類１",
			A."分類２"
</sql>
 
 <!-- sl:暂定，更新local -->
<sql id="updatelocalstockflg1" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET
		CASE  
			WHEN  "途中在庫_入庫" is null OR
					"途中在庫_入庫"  ==0  OR
					"途中在庫_入庫"  =='' THEN 0
			ELSE "途中在庫_入庫" = CAST(!put as int4)
		END,
		 
			"LOCAL在庫" = CAST(!local as int4),
		CASE  
			WHEN  "途中在庫_仕入" is null OR
					"途中在庫_仕入"  ==0  OR
					"途中在庫_仕入"  =='' THEN 0
			ELSE "途中在庫_仕入" = CAST(!purchase as int4)
		END,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 	<if exists="productno"> AND (	
		  "商品管理番号" = !productno
		)
	    </if>
	   <if notexists="productno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="preproduct"> AND (	
		  "親子区分" = !preproduct
		)
	    </if>
	   <if notexists="preproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="producttype"> AND (	
		  "商品種別" = !producttype
		)
	    </if>
	   <if notexists="producttype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
 	<if exists="productsub1"> AND (	
		  "分類１" = !productsub1
		)
	    </if>
	   <if notexists="productsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="productsub2"> AND (	
		  "分類２" = !productsub2
		)
	    </if>
	    <if notexists="productsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
</sql>


 <!-- sl:非暂定，更新local -->
<sql id="updatelocalstockflg0" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET
		CASE  
			WHEN  "途中在庫_入庫" is null OR
					"途中在庫_入庫"  ==0  OR
					"途中在庫_入庫"  =='' THEN 0
			ELSE "途中在庫_入庫" = CAST(!put as int4)
		END,
		 
			"LOCAL在庫" = CAST(!local as int4),
		CASE  
			WHEN  "途中在庫_仕入" is null OR
					"途中在庫_仕入"  ==0  OR
					"途中在庫_仕入"  =='' THEN 0
			ELSE "途中在庫_仕入" = CAST(!purchase as int4)
		END,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 	<if exists="asin"> AND (	
		  "ASIN番号" = !asin
		)
	    </if>
	   <if notexists="asin"> AND (	
		  "ASIN番号" is NULL
		)
	   </if> 
	 	<if exists="sku"> AND (	
		  "SKU番号" = !sku
		)
	    </if>
	   <if notexists="sku"> AND (	
		  "SKU番号" is NULL
		)
	   </if>
	
		   
</sql>

<!-- sl：Excel数据查询 -->
<sql id="selectstock" >
 select
	a."商品種別" as type,
	a."商品管理番号" as no,
	a."親子区分" as preproduct,	
	a."分類１" as sub1,
	a."分類２" as sub2,
	a."ASIN番号" as asin,
	a."SKU番号" as sku,
	a."LABEL番号" as label,
	a."商品名称" as productname,
	a."仕入価格" as price,
 CASE
	WHEN (d."FBA在庫" IS NULL OR d."FBA在庫" = 0 ) AND (d."FBM在庫" IS NULL OR d."FBM在庫" = 0 )THEN NULL
	WHEN ( d."FBM在庫" IS NULL OR d."FBM在庫" = 0 )AND ( d."FBA在庫" != 0 AND d."FBA在庫" IS NOT NULL) THEN 'FBA'
	WHEN  (d."FBA在庫" IS NULL OR d."FBA在庫" = 0) AND (d."FBM在庫" != 0 AND d."FBM在庫" IS NOT NULL ) THEN 'FBM'
	ELSE ''
 END  AS send ,
	d."FBA在庫" as fba,
	d."FBM在庫" as fbm,
	d."途中在庫_入庫" as put,	
	d."LOCAL在庫" as local,
	d."途中在庫_仕入" as purchase,
	
 ((CASE 
	WHEN d."FBA在庫" is null THEN 0
	ELSE CAST(d."FBA在庫" as int4) END)+
 (CASE 
	WHEN d."FBM在庫" is null THEN 0
	ELSE CAST(d."FBM在庫" as int4) END)+
 (CASE 
	WHEN d."途中在庫_入庫" is null THEN 0
	ELSE CAST(d."途中在庫_入庫" as int4) END)) as stockonsell,

 ((CASE 
	WHEN d."LOCAL在庫" is null THEN 0
	ELSE CAST(d."LOCAL在庫" as int4) END)+
 (CASE 
	WHEN d."途中在庫_仕入" is null THEN 0
	ELSE CAST(d."途中在庫_仕入" as int4) END)) as stockprepare,

 ((CASE WHEN d."FBA在庫" is null THEN 0
	ELSE CAST(d."FBA在庫" as int4) END)+
 (CASE  WHEN d."FBM在庫" is null THEN 0
	ELSE CAST(d."FBM在庫" as int4) END)+
 (CASE  WHEN d."途中在庫_入庫" is null THEN 0
	ELSE CAST(d."途中在庫_入庫" as int4) END)+
 (CASE  WHEN d."LOCAL在庫" is null THEN 0
	ELSE CAST(d."LOCAL在庫" as int4) END)+
 (CASE  WHEN d."途中在庫_仕入" is null THEN 0
	ELSE CAST(d."途中在庫_仕入" as int4)  END)) as stockall,
	
	
 lpad((CASE  WHEN "販売数量（直近３日間）" is null THEN '0'
	ELSE CAST("販売数量（直近３日間）" as VARCHAR) 
	END), 3, '0')  as selled3, 
 lpad(	(CASE  WHEN "販売数量（直近７日間）" is null THEN '0'
	ELSE CAST("販売数量（直近７日間）" as VARCHAR) 
	END), 3, '0')  as selled7,
 lpad(	(CASE  WHEN "販売数量（直近３０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近３０日間）" as VARCHAR) 
	END), 3, '0')  as selled30,
 lpad(	(CASE  WHEN "販売数量（直近６０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近６０日間）" as VARCHAR) 
	END), 3, '0')  as selled60,
 lpad(	(CASE  WHEN "販売数量（直近９０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近９０日間）" as VARCHAR) 
	END), 3, '0')  as selled90,
 lpad(	(CASE  WHEN "販売数量（直近１８０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近１８０日間）" as VARCHAR) 
	END), 3, '0')  as selled180,
 lpad(	(CASE  WHEN "販売数量（直近３６０日間）" is null THEN '0'
	ELSE CAST("販売数量（直近３６０日間）" as VARCHAR) 
	END), 3, '0')  as selled360,
	
  round((((CASE  WHEN "販売数量（直近３日間）" is null THEN 0
	ELSE CAST("販売数量（直近３日間）" as int4) END) * 0.05)+
	((CASE  WHEN "販売数量（直近７日間）" is null THEN 0
	ELSE CAST("販売数量（直近７日間）" as int4) END) * 0.05)+
	((CASE  WHEN "販売数量（直近３０日間）" is null THEN 0
	ELSE CAST("販売数量（直近３０日間）" as int4) END) * 0.1)+
	((CASE  WHEN "販売数量（直近６０日間）" is null THEN 0
	ELSE CAST("販売数量（直近６０日間）" as int4) END) * 0.3)+
	((CASE  WHEN "販売数量（直近９０日間）" is null THEN 0
	ELSE CAST("販売数量（直近９０日間）" as int4) END) * 0.3)+
	((CASE  WHEN "販売数量（直近１８０日間）" is null THEN 0
	ELSE CAST("販売数量（直近１８０日間）" as int4) END) * 0.1)+
	((CASE  WHEN "販売数量（直近３６０日間）" is null THEN 0
	ELSE CAST("販売数量（直近３６０日間）" as int4) END) * 0.1) ),2 ) AS dayaverage,

	c."在庫販売可能日数" as stocknumber,
	c."保有数量販売可能日数" as salenumber,	
	c."推奨納品数量" as deliveryquantity,
	c."推奨仕入数量" as purchasequantity
 from
	"MST_出品マスタ情報" a
	left join "MST_販売数量情報" b on a."ASIN番号"=b."ASIN番号"and a."SKU番号"=b."SKU番号"
	left join "MST_入庫仕入推奨数量情報" c on a ."ASIN番号"=c."ASIN番号"and a."SKU番号"=c."SKU番号"
    left join "MST_在庫情報"  d on a."ASIN番号"=d."ASIN番号"and a."SKU番号"=d."SKU番号"
	WHERE
			1=1
	AND a."親子区分" = '子商品'
		AND A."店舗ID" = :shopid  
	ORDER BY
			A."商品種別",
			A."商品管理番号",
			A."分類１",
			A."分類２"
</sql>
  
 
</sqls>

