<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqls>
<sqls>

	<sql id="searchproducttype">
		SELECT DISTINCT
			"商品種別" as value,
			substr("商品種別",4) as text
		FROM
			"MST_出品マスタ情報" 
		WHERE
			"length" ( 商品種別 ) > 0 
			AND "店舗ID" = :shopId 
		ORDER BY
			"商品種別"
	</sql>

	<sql id="searchproducno">
		SELECT DISTINCT
			"商品管理番号" AS value,
			"商品管理番号" AS text 
		FROM
			"MST_出品マスタ情報" 
		WHERE
			"length" ( 商品管理番号 ) > 0 
			AND "店舗ID" = :shopId  
		ORDER BY
			"商品管理番号"
	</sql>

	<sql id="updatelocalstockflg1_local" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET "LOCAL在庫" = !local,
			"更新日時"=now()
		WHERE 
			"店舗ID" =!shopid
		<if exists="productno"> AND (	
			"商品管理番号" = !productno
			)
			</if>
		<if notexists="productno"> AND (	
			"商品管理番号" is NULL
			)
		</if> 
			<if exists="preproduct"> AND (	
			"親子区分" = !preproduct
			)
			</if>
		<if notexists="preproduct"> AND (	
			"親子区分" is NULL
			)
		</if>
			<if exists="producttype"> AND (	
			"商品種別" = !producttype
			)
			</if>
		<if notexists="producttype"> AND (	
			"商品種別" is NULL
			)
		</if>
		<if exists="productsub1"> AND (	
			"分類１" = !productsub1
			)
			</if>
		<if notexists="productsub1"> AND (	
			"分類１" is NULL
			)
		</if>
		<if exists="productsub2"> AND (	
			"分類２" = !productsub2
			)
		</if>
		<if notexists="productsub2"> AND (	
			"分類２" is NULL
			)
		</if>
	</sql>

	<sql id="updatelocalstockflg1_put" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET "途中在庫_入庫" = !put,
			"更新日時"=now()
		WHERE 
			"店舗ID" =!shopid
		<if exists="productno"> AND (	
			"商品管理番号" = !productno
			)
			</if>
		<if notexists="productno"> AND (	
			"商品管理番号" is NULL
			)
		</if> 
			<if exists="preproduct"> AND (	
			"親子区分" = !preproduct
			)
			</if>
		<if notexists="preproduct"> AND (	
			"親子区分" is NULL
			)
		</if>
			<if exists="producttype"> AND (	
			"商品種別" = !producttype
			)
			</if>
		<if notexists="producttype"> AND (	
			"商品種別" is NULL
			)
		</if>
		<if exists="productsub1"> AND (	
			"分類１" = !productsub1
			)
			</if>
		<if notexists="productsub1"> AND (	
			"分類１" is NULL
			)
		</if>
		<if exists="productsub2"> AND (	
			"分類２" = !productsub2
			)
		</if>
		<if notexists="productsub2"> AND (	
			"分類２" is NULL
			)
		</if>
	</sql>

	<sql id="updatelocalstockflg1_purchase" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET "途中在庫_仕入" = !purchase,
			"更新日時"=now()
		WHERE 
			"店舗ID" =!shopid
		<if exists="productno"> AND (	
			"商品管理番号" = !productno
			)
			</if>
		<if notexists="productno"> AND (	
			"商品管理番号" is NULL
			)
		</if> 
			<if exists="preproduct"> AND (	
			"親子区分" = !preproduct
			)
			</if>
		<if notexists="preproduct"> AND (	
			"親子区分" is NULL
			)
		</if>
			<if exists="producttype"> AND (	
			"商品種別" = !producttype
			)
			</if>
		<if notexists="producttype"> AND (	
			"商品種別" is NULL
			)
		</if>
		<if exists="productsub1"> AND (	
			"分類１" = !productsub1
			)
			</if>
		<if notexists="productsub1"> AND (	
			"分類１" is NULL
			)
		</if>
		<if exists="productsub2"> AND (	
			"分類２" = !productsub2
			)
		</if>
		<if notexists="productsub2"> AND (	
			"分類２" is NULL
			)
		</if>
	</sql>

	<sql id="updatelocalstockflg0" paramPrefix="!">
			UPDATE "MST_在庫情報" 
			SET
				CASE  
					WHEN  "途中在庫_入庫" is null OR
							"途中在庫_入庫"  ==0  OR
							"途中在庫_入庫"  =='' THEN 0
					ELSE "途中在庫_入庫" = CAST(!put as int4)
				END,
				
					"LOCAL在庫" = CAST(!local as int4),
				CASE  
					WHEN  "途中在庫_仕入" is null OR
							"途中在庫_仕入"  ==0  OR
							"途中在庫_仕入"  =='' THEN 0
					ELSE "途中在庫_仕入" = CAST(!purchase as int4)
			END,
				"更新日時"=now()
			WHERE 
				"店舗ID" =!shopid
			<if exists="asin"> AND (	
				"ASIN番号" = !asin
			)
			</if>
			<if notexists="asin"> AND (	
				"ASIN番号" is NULL
				)
			</if> 
			<if exists="sku"> AND (	
				"SKU番号" = !sku
				)
			</if>
			<if notexists="sku"> AND (	
				"SKU番号" is NULL
				)
			</if>
			
	</sql>

	<sql id="updatelocalstockflg0_local" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET "LOCAL在庫" = !local,
			"更新日時"=now()
		WHERE 
			"店舗ID" =!shopid
		<if exists="asin"> AND (	
			"ASIN番号" = !asin
			)
		</if>
		<if notexists="asin"> AND (	
			"ASIN番号" is NULL
			)
		</if> 
		<if exists="sku"> AND (	
			"SKU番号" = !sku
			)
		</if>
		<if notexists="sku"> AND (	
			"SKU番号" is NULL
			)
		</if>
	</sql>

	<sql id="updatelocalstockflg0_put" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET "途中在庫_入庫" = !put,
			"更新日時"=now()
		WHERE 
			"店舗ID" =!shopid
		<if exists="asin"> AND (	
			"ASIN番号" = !asin
		)
		</if>
		<if notexists="asin"> AND (	
			"ASIN番号" is NULL
			)
		</if> 
		<if exists="sku"> AND (	
			"SKU番号" = !sku
			)
		</if>
		<if notexists="sku"> AND (	
			"SKU番号" is NULL
			)
		</if>
	</sql>

	<sql id="updatelocalstockflg0_purchase" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET "途中在庫_仕入" = !purchase,
			"更新日時"=now()
		WHERE 
			"店舗ID" =!shopid
		<if exists="asin"> AND (	
			"ASIN番号" = !asin
		)
		</if>
		<if notexists="asin"> AND (	
			"ASIN番号" is NULL
			)
		</if> 
		<if exists="sku"> AND (	
			"SKU番号" = !sku
			)
		</if>
		<if notexists="sku"> AND (	
			"SKU番号" is NULL
			)
		</if>
	</sql>

	<sql id="selectstockinfo0_excel" >
		select
			a."商品種別" as type,
			a."商品管理番号" as pno,
			a."親子区分" as preproduct,	
			a."分類１" as sub1,
			a."分類２" as sub2,
			a."ASIN番号" as asin,
			a."SKU番号" as sku,
			a."LABEL番号" as label,
			a."商品名称" as productname,
			e."価格" as price,
			case
				when a."親子区分" = '親商品' then null
				when d."FBA在庫" != 0 then 'FBA'
				when d."FBA在庫" is null and d."FBM在庫" is null then '-'
				when d."FBA在庫" is null and d."FBM在庫" is not null then 'FBM'
				when d."FBA在庫" = 0 and d."FBM在庫" is null then 'FBA'
				when d."FBA在庫" = 0 and d."FBM在庫" = 0 then '-'
				when d."FBA在庫" = 0 and d."FBM在庫" != 0 then 'FBM'
			end as shippingway,
			d."FBA在庫" as fba,
			d."FBM在庫" as fbm,
			d."途中在庫_入庫" as put,	
			d."LOCAL在庫" as local,
			d."途中在庫_仕入" as purchase,
			case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) end as stockonsell,
			case when a."親子区分" = '親商品' then null else COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockprepare,
			case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) + COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockall,
			b."販売数量（直近３日間）" as selled3,
			b."販売数量（直近７日間）" as selled7, 
			b."販売数量（直近３０日間）" as selled30, 
			b."販売数量（直近６０日間）" as selled60, 
			b."販売数量（直近９０日間）" as selled90, 
			b."販売数量（直近１８０日間）" as selled180, 
			b."販売数量（直近３６０日間）" as selled360, 
			case when a."親子区分" = '親商品' then null else rpad(cast(round(b."販売数量（日平均値）", 5) as varchar), 5, '0') end as dayaverage,
			c."在庫販売可能日数" as stocknumber,
			c."保有数量販売可能日数" as salenumber,
			c."推奨納品数量" as deliveryquantity,
			c."推奨仕入数量" as purchasequantity,
			a."店舗ID" as shopid,
			a."暫定フラグ" as zt_flg
		from
			"MST_出品マスタ情報" a
			left join "MST_販売数量情報" b on a."ASIN番号" = b."ASIN番号" and a."SKU番号" = b."SKU番号" and a."店舗ID" = b."店舗ID"
			left join "MST_入庫仕入推奨数量情報" c on a."ASIN番号" = c."ASIN番号" and a."SKU番号" = c."SKU番号" and a."店舗ID" = c."店舗ID"
			left join "MST_在庫情報"  d on a."ASIN番号" = d."ASIN番号" and a."SKU番号" = d."SKU番号" and a."暫定フラグ" = d."暫定フラグ" and a."店舗ID" = d."店舗ID" 
			left join "IPT_全出品情報" e on a."ASIN番号" = e."ASIN 1" and a."SKU番号" = e."出品者SKU" and a."店舗ID" = e."店舗ID" 
			left join "MST_ソート情報" S1 on a."商品種別" = S1."商品種別" and S1."分類" = '分類１' and a."分類１" = S1."内容" and a."店舗ID" = S1."店舗ID"
			left join "MST_ソート情報" S2 on a."商品種別" = S2."商品種別" and S2."分類" = '分類２' and a."分類２" = S2."内容" and a."店舗ID" = S2."店舗ID"
		where
			a."暫定フラグ" = '0'
			and
			a."店舗ID" = :shopid
			and 
			a."親子区分" = '子商品'
		order by
			a."商品種別",
			a."商品管理番号",
			COALESCE(cast(S1."ソート" as varchar), a."分類１"),
			COALESCE(cast(S2."ソート" as varchar), a."分類２")
	</sql>

	<sql id="selectstockinfo1_excel" >
		select
			a."商品種別" as type,
			a."商品管理番号" as pno,
			a."親子区分" as preproduct,	
			a."分類１" as sub1,
			a."分類２" as sub2,
			a."ASIN番号" as asin,
			a."SKU番号" as sku,
			a."LABEL番号" as label,
			a."商品名称" as productname,
			e."価格" as price,
			case
				when a."親子区分" = '親商品' then null
				when d."FBA在庫" != 0 then 'FBA'
				when d."FBA在庫" is null and d."FBM在庫" is null then '-'
				when d."FBA在庫" is null and d."FBM在庫" is not null then 'FBM'
				when d."FBA在庫" = 0 and d."FBM在庫" is null then 'FBA'
				when d."FBA在庫" = 0 and d."FBM在庫" = 0 then '-'
				when d."FBA在庫" = 0 and d."FBM在庫" != 0 then 'FBM'
			end as shippingway,
			d."FBA在庫" as fba,
			d."FBM在庫" as fbm,
			d."途中在庫_入庫" as put,
			d."LOCAL在庫" as local,
			d."途中在庫_仕入" as purchase,
			case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) end as stockonsell,
			case when a."親子区分" = '親商品' then null else COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockprepare,
			case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) + COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockall,
			b."販売数量（直近３日間）" as selled3,
			b."販売数量（直近７日間）" as selled7, 
			b."販売数量（直近３０日間）" as selled30, 
			b."販売数量（直近６０日間）" as selled60, 
			b."販売数量（直近９０日間）" as selled90, 
			b."販売数量（直近１８０日間）" as selled180, 
			b."販売数量（直近３６０日間）" as selled360, 
			case when a."親子区分" = '親商品' then null else rpad(cast(round(b."販売数量（日平均値）", 5) as varchar), 5, '0') end as dayaverage,
			c."在庫販売可能日数" as stocknumber,
			c."保有数量販売可能日数" as salenumber,
			c."推奨納品数量" as deliveryquantity,
			c."推奨仕入数量" as purchasequantity,
			a."店舗ID" as shopid,
			a."暫定フラグ" as zt_flg
		from
			"MST_出品マスタ情報" a
			left join "MST_販売数量情報" b on a."ASIN番号"=b."ASIN番号" and a."SKU番号"=b."SKU番号" and a."店舗ID" = b."店舗ID"
			left join "MST_入庫仕入推奨数量情報" c on a."ASIN番号"=c."ASIN番号" and a."SKU番号"=c."SKU番号" and a."店舗ID" = c."店舗ID"
			left join "MST_在庫情報"  d on a."ASIN番号"=d."ASIN番号" and a."SKU番号"=d."SKU番号" and a."暫定フラグ" = d."暫定フラグ" and a."店舗ID" = d."店舗ID" 
			left join "IPT_全出品情報" e on a."ASIN番号" = e."ASIN 1" and a."SKU番号" = e."出品者SKU" and a."店舗ID" = e."店舗ID" 
			left join "MST_ソート情報" S1 on a."商品種別" = S1."商品種別" and S1."分類" = '分類１' and a."分類１" = S1."内容" and a."店舗ID" = S1."店舗ID"
			left join "MST_ソート情報" S2 on a."商品種別" = S2."商品種別" and S2."分類" = '分類２' and a."分類２" = S2."内容" and a."店舗ID" = S2."店舗ID"
		where
			a."暫定フラグ" = '1'
			and
			a."店舗ID" = :shopid
			and 
			a."親子区分" = '子商品'
		order by
			a."商品種別",
			a."商品管理番号",
			COALESCE(cast(S1."ソート" as varchar), a."分類１"),
			COALESCE(cast(S2."ソート" as varchar), a."分類２")
	</sql>

	<sql id="selectstockinfo">
		select 
			T.type,
			T.pno,
			T.preproduct,	
			T.sub1,
			T.sub2,
			T.asin,
			T.sku,
			T.label,
			T.productname,
			T.shippingway,
			T.fba,
			T.fbm,
			T.put,
			T.local,
			T.purchase,
			T.stockonsell,
			T.stockprepare,
			T.stockall,
			T.selled3,
			T.selled7,
			T.selled30,
			T.selled60,
			T.selled90,
			T.selled180,
			T.selled360,
			T.dayaverage,
			T.stocknumber,
			T.salenumber,
			T.deliveryquantity,
			T.purchasequantity,
			T.zt_flg
		from
			(
				select
					a."商品種別" as type,
					a."商品管理番号" as pno,
					a."親子区分" as preproduct,	
					a."分類１" as sub1,
					a."分類２" as sub2,
					a."ASIN番号" as asin,
					a."SKU番号" as sku,
					a."LABEL番号" as label,
					a."商品名称" as productname,
					case
						when a."親子区分" = '親商品' then null
						when d."FBA在庫" != 0 then 'FBA'
						when d."FBA在庫" is null and d."FBM在庫" is null then '-'
						when d."FBA在庫" is null and d."FBM在庫" is not null then 'FBM'
						when d."FBA在庫" = 0 and d."FBM在庫" is null then 'FBA'
						when d."FBA在庫" = 0 and d."FBM在庫" = 0 then '-'
						when d."FBA在庫" = 0 and d."FBM在庫" != 0 then 'FBM'
					end as shippingway,
					d."FBA在庫" as fba,
					d."FBM在庫" as fbm,
					d."途中在庫_入庫" as put,	
					d."LOCAL在庫" as local,
					d."途中在庫_仕入" as purchase,
					case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) end as stockonsell,
					case when a."親子区分" = '親商品' then null else COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockprepare,
					case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) + COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockall,
					lpad(COALESCE(CAST(b."販売数量（直近３日間）" as VARCHAR),'') , 3, '-')  as selled3,
					lpad(COALESCE(CAST(b."販売数量（直近７日間）" as VARCHAR),'') , 3, '-')  as selled7, 
					lpad(COALESCE(CAST(b."販売数量（直近３０日間）" as VARCHAR),'') , 3, '-')  as selled30, 
					lpad(COALESCE(CAST(b."販売数量（直近６０日間）" as VARCHAR),'') , 3, '-')  as selled60, 
					lpad(COALESCE(CAST(b."販売数量（直近９０日間）" as VARCHAR),'') , 3, '-')  as selled90, 
					lpad(COALESCE(CAST(b."販売数量（直近１８０日間）" as VARCHAR),'') , 3, '-')  as selled180, 
					lpad(COALESCE(CAST(b."販売数量（直近３６０日間）" as VARCHAR),'') , 3, '-')  as selled360, 
					case when a."親子区分" = '親商品' then null else rpad(cast(round(b."販売数量（日平均値）", 5) as varchar), 6, '0') end as dayaverage,
					c."在庫販売可能日数" as stocknumber,
					c."保有数量販売可能日数" as salenumber,
					c."推奨納品数量" as deliveryquantity,
					c."推奨仕入数量" as purchasequantity,
					a."店舗ID" as shopid,
					a."暫定フラグ" as zt_flg
				from
					"MST_出品マスタ情報" a
					left join "MST_販売数量情報" b on a."ASIN番号"=b."ASIN番号" and a."SKU番号"=b."SKU番号" and a."店舗ID" = b."店舗ID"
					left join "MST_入庫仕入推奨数量情報" c on a."ASIN番号"=c."ASIN番号" and a."SKU番号"=c."SKU番号" and a."店舗ID" = c."店舗ID"
					left join "MST_在庫情報"  d on a."ASIN番号"=d."ASIN番号" and a."SKU番号"=d."SKU番号" and a."暫定フラグ" = d."暫定フラグ" and a."店舗ID" = d."店舗ID" 
				where
					a."暫定フラグ" = '0'
					and
					a."店舗ID" = :shopid
				
				union all
				
				select
					a."商品種別" as type,
					a."商品管理番号" as pno,
					a."親子区分" as preproduct,	
					a."分類１" as sub1,
					a."分類２" as sub2,
					a."ASIN番号" as asin,
					a."SKU番号" as sku,
					a."LABEL番号" as label,
					a."商品名称" as productname,
					null as shippingway,
					d."FBA在庫" as fba,
					d."FBM在庫" as fbm,
					d."途中在庫_入庫" as put,	
					d."LOCAL在庫" as local,
					d."途中在庫_仕入" as purchase,
					case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) end as stockonsell,
					case when a."親子区分" = '親商品' then null else COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockprepare,
					case when a."親子区分" = '親商品' then null else COALESCE(d."FBA在庫", 0) + COALESCE(d."FBM在庫", 0) + COALESCE(d."途中在庫_入庫", 0) + COALESCE(d."LOCAL在庫", 0) + COALESCE(d."途中在庫_仕入", 0) end as stockall,
					null as selled3,
					null as selled7, 
					null as selled30, 
					null as selled60, 
					null as selled90, 
					null as selled180, 
					null as selled360, 
					null as dayaverage,
					null as stocknumber,
					null as salenumber,
					null as deliveryquantity,
					null as purchasequantity,
					a."店舗ID" as shopid,
					a."暫定フラグ" as zt_flg
				from
					"MST_出品マスタ情報" a
					left join "MST_在庫情報" d on 
						a."商品管理番号"=d."商品管理番号" and 
						a."親子区分"=d."親子区分" and 
						a."商品種別"=d."商品種別" and 
						a."分類１"=d."分類１" and 
						a."分類２"=d."分類２" and 
						a."暫定フラグ" = d."暫定フラグ" and 
						a."店舗ID" = d."店舗ID" 
				where
					a."暫定フラグ" = '1'
					and
					a."店舗ID" = :shopid
			) T
			LEFT JOIN "MST_ソート情報" S1 ON 
				T."type" = S1."商品種別" AND 
				S1."分類" = '分類１' AND 
				T."sub1" = S1."内容" AND
				T."shopid" = S1."店舗ID"
			LEFT JOIN "MST_ソート情報" S2 ON 
				T."type" = S2."商品種別" AND 
				S2."分類" = '分類２' AND 
				T."sub2" = S2."内容" AND
				T."shopid" = S2."店舗ID"
		where
			1=1
			<if exists="opt_productno"> and (
				<if istrue="opt_productno == 'マスタ未登録'"> T."pno" is null </if>
				<if istrue="opt_productno != 'マスタ未登録'"> T."pno" = :opt_productno </if>
				)
			</if>

			<if exists="text_keyword"> and (
				UPPER(T."type") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."pno") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."preproduct") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."sub1") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."sub2") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."sku") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."asin") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."label") LIKE concat('%', :text_keyword ,'%') OR
				UPPER(T."productname") LIKE concat('%', :text_keyword ,'%') 
				)
			</if>

			<if exists="ptype"> and (	
				T."type" IN (@ptype)
				)
			</if>

			<if exists="shippingway"> and (	
				T."shippingway" IN (@shippingway)
				)
			</if>

			order by
				T."pno",
				T."preproduct" desc,
				COALESCE(cast(S1."ソート" as varchar), T."sub1"),
				COALESCE(cast(S2."ソート" as varchar), T."sub2")
	</sql>
 

<!-- sl:推奨数量入り-推奨納品数量 -->
	<sql id="updatedeliverynumber">
		update "MST_入庫仕入推奨数量情報" set
			"推奨納品数量" = 
				COALESCE(MST3."販売数量（日平均値）", 0) * :daycount - 
				(	COALESCE(MST2."FBA在庫", 0) + 
					COALESCE(MST2."FBM在庫", 0) + 
					COALESCE(MST2."途中在庫_入庫", 0)),
			"更新日時" = now()
		from 
			"MST_出品マスタ情報" MST1,
			"MST_在庫情報" MST2,
			"MST_販売数量情報" MST3
		where 
			"MST_入庫仕入推奨数量情報"."SKU番号" = MST1."SKU番号"
			and
			"MST_入庫仕入推奨数量情報"."ASIN番号" = MST1."ASIN番号"
			and
			MST1."暫定フラグ" = '0'
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = MST1."店舗ID"
			and
			MST1."親子区分" = '子商品'
			and
			"MST_入庫仕入推奨数量情報"."SKU番号" = MST2."SKU番号"
			and
			"MST_入庫仕入推奨数量情報"."ASIN番号" = MST2."ASIN番号"
			and
			MST2."暫定フラグ" = '0'
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = MST2."店舗ID"
			and
			"MST_入庫仕入推奨数量情報"."SKU番号" = MST3."SKU番号"
			and
			"MST_入庫仕入推奨数量情報"."ASIN番号" = MST3."ASIN番号"
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = MST3."店舗ID"
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = :shopId
	</sql>

	<sql id="selectdeliverynumber">
		SELECT DISTINCT
			"推奨納品数量" num
		FROM
			"MST_入庫仕入推奨数量情報" 
		WHERE
			"SKU番号" = :sku
			and
			"ASIN番号" = :asin
			and
			"店舗ID" = :shopId
			and
			"推奨納品数量" > 0
	</sql>



<!-- sl:推奨数量入り-推奨仕入数量  -->
	<sql id="updatepurchasenumber">
		update "MST_入庫仕入推奨数量情報" set
			"推奨仕入数量" = 
					COALESCE(MST3."販売数量（日平均値）", 0) * cast(:date as int) - 
					(	COALESCE(MST2."FBA在庫", 0) + 
						COALESCE(MST2."FBM在庫", 0) + 
						COALESCE(MST2."途中在庫_入庫", 0) + 
						COALESCE(MST2."LOCAL在庫", 0) + 
						COALESCE(MST2."途中在庫_仕入", 0)),
			"更新日時" = now()
		from 
			"MST_出品マスタ情報" MST1,
			"MST_在庫情報" MST2,
			"MST_販売数量情報" MST3
		where 
			"MST_入庫仕入推奨数量情報"."SKU番号" = MST1."SKU番号"
			and
			"MST_入庫仕入推奨数量情報"."ASIN番号" = MST1."ASIN番号"
			and
			MST1."暫定フラグ" = '0'
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = MST1."店舗ID"
			and
			MST1."親子区分" = '子商品'
			and
			"MST_入庫仕入推奨数量情報"."SKU番号" = MST2."SKU番号"
			and
			"MST_入庫仕入推奨数量情報"."ASIN番号" = MST2."ASIN番号"
			and
			MST2."暫定フラグ" = '0'
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = MST2."店舗ID"
			and
			"MST_入庫仕入推奨数量情報"."SKU番号" = MST3."SKU番号"
			and
			"MST_入庫仕入推奨数量情報"."ASIN番号" = MST3."ASIN番号"
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = MST3."店舗ID"
			and
			"MST_入庫仕入推奨数量情報"."店舗ID" = :shopId
	</sql>

</sqls>

