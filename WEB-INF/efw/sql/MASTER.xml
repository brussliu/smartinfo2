<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqls>
<sqls>
<!-- sl：检索商品分类 -->
<sql id="searchproducttype">
 SELECT DISTINCT
	"商品種別" as value,
	substr("商品種別",4) as text
 FROM
	"MST_出品マスタ情報" 
 WHERE
	"length" ( 商品種別 ) > 0 
	AND "店舗ID" = :shopId 
 ORDER BY
	"商品種別"
	</sql>
<!-- sl：检索商品番号 -->
<sql id="searchproducno">
 SELECT DISTINCT
	"商品管理番号" AS value,
	"商品管理番号" AS text 
  FROM
	"MST_出品マスタ情報" 
 WHERE
	"length" ( 商品管理番号 ) > 0 
	AND "店舗ID" = :shopId  
 ORDER BY
	"商品管理番号"
</sql>
<!-- sl：检索商品总结 -->
<sql id="selectmasterinfo" >
	SELECT
		  M."商品種別" as type
		, M."商品管理番号" as no
		, M."親子区分" as preproduct
		, M."分類１" as sub1
		, M."分類２" as sub2
		, M."ASIN番号" as asin
		, M."SKU番号" as sku
		, M."LABEL番号" as label
		, M."仕入価格" as price
		, M."仕入申報価格（元）" as price2
		, M."仕入申報価格（ドル）" as price3
		, M."FBM発送方式" as fba
		, M."商品名称" as name
		, M."暫定フラグ" as flg
	FROM
		"MST_出品マスタ情報" M
	LEFT JOIN "MST_ソート情報" S1 ON 
		M."商品種別" = S1."商品種別" AND 
		S1."分類" = '分類１' AND 
		M."分類１" = S1."内容" AND
		M."店舗ID" = S1."店舗ID"
	LEFT JOIN "MST_ソート情報" S2 ON 
		M."商品種別" = S2."商品種別" AND 
		S2."分類" = '分類２' AND 
		M."分類２" = S2."内容" AND
		M."店舗ID" = S2."店舗ID"
	WHERE
	1=1
 	<if exists="productno"> AND (
		<if istrue="productno == 'マスタ未登録'"> M."商品管理番号" is NULL </if>
		<if istrue="productno != 'マスタ未登録'"> M."商品管理番号" = :productno </if>
		)
	</if>

	<if exists="keyword"> AND (
		UPPER(M."商品種別") LIKE concat('%', :keyword ,'%') OR
		UPPER(M."商品管理番号") LIKE concat('%', :keyword ,'%') OR
		UPPER(M."親子区分") LIKE concat('%', :keyword ,'%') OR

		UPPER(M."分類１") LIKE concat('%', :keyword ,'%') OR
		UPPER(M."分類２") LIKE concat('%', :keyword ,'%') OR
		UPPER(M."SKU番号") LIKE concat('%', :keyword ,'%') OR

		UPPER(M."ASIN番号") LIKE concat('%', :keyword ,'%') OR
		UPPER(M."LABEL番号") LIKE concat('%', :keyword ,'%')OR
		UPPER(M."FBM発送方式") LIKE concat('%', :keyword ,'%') OR
		UPPER(M."商品名称") LIKE concat('%', :keyword ,'%')
		)
	</if>

	 <if exists="ptype"> AND (	
		  M."商品種別" IN ( @ptype )
		)
	 </if>
		AND M."店舗ID" = :shopid  
	ORDER BY 
		M."商品管理番号",
		M."親子区分" desc,
    	COALESCE(cast(S1."ソート" as varchar), M."分類１"),
    	COALESCE(cast(S2."ソート" as varchar), M."分類２")
</sql>
 
<!-- sl:暂定为1时更新检索 -->
<sql id="searchmasterinfoflg1" paramPrefix="!">
	SELECT
		  "商品種別" as type
		, "商品管理番号" as no
		, "LABEL番号" as label
		
		, "親子区分" as preproduct
		, "分類１" as sub1
		, "分類２" as sub2
	
		, "仕入価格" as price1
		, "仕入申報価格（元）" as price2
		, "仕入申報価格（ドル）" as price3
		, "FBM発送方式" as fba
		, "商品名称" as name
		, "暫定フラグ" as flg

	FROM
		"MST_出品マスタ情報" 
	WHERE
	1=1
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
	 	<if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if>
	    <if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	    <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	     </if>
 	 	<if exists="oldsub1"> AND (	
		  "分類１" = !oldsub1
		)
	    </if>
	   <if notexists="oldsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="oldsub2"> AND (	
		  "分類２" = !oldsub2
		)
	    </if>
	    <if notexists="oldsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
		AND "店舗ID" = !shopid  
 
</sql>

<!-- sl:暂定为0时更新检索 -->
<sql id="searchmasterinfoflg0" paramPrefix="!">
	SELECT
		  "商品種別" as type
		, "商品管理番号" as no
		, "ASIN番号" as asin
		, "SKU番号" as sku
		, "LABEL番号" as label
		, "親子区分" as preproduct
		, "分類１" as sub1
		, "分類２" as sub2
		, "仕入価格" as price1
		, "仕入申報価格（元）" as price2
		, "仕入申報価格（ドル）" as price3
		, "FBM発送方式" as fba
		, "商品名称" as name
		, "暫定フラグ" as flg
	FROM
		"MST_出品マスタ情報" 
	WHERE
	1=1
	 	<if exists="oldasin"> AND (	
		  "ASIN番号" = !oldasin
		)
	    </if>
	   <if notexists="oldasin"> AND (	
		  "ASIN番号" is NULL
		)
	   </if>
	 	<if exists="oldsku"> AND (	
		  "SKU番号" = !oldsku
		)
	    </if>
	   <if notexists="oldsku"> AND (	
		  "SKU番号" is NULL
		)
	   </if>
		AND "店舗ID" = !shopid  
 
</sql>



<!-- sl：新规-親商品 -->
<sql id="savemasterinfopre">
	INSERT INTO "MST_出品マスタ情報"
	(
		"商品管理番号",
		"親子区分",
		"商品種別",
		"商品名称",
		"暫定フラグ",
		"店舗ID",
		"登録日時",
		"更新日時"
	) VALUES (
		:productno,--商品管理番号
		:preproduct,--親子区分
		:producttype,--商品種別
		:productname,--商品名称
		'1',--暫定フラグ
		:shopid,--店舗ID
		now(), --登録日時
		now() --更新日時
	)
</sql>
<!-- sl：新规-子商品 -->
<sql id="savemasterinfosub">
	INSERT INTO "MST_出品マスタ情報"
	(
		"商品管理番号",
		"親子区分",
		"商品種別",
		"分類１",
		"分類２",
		"仕入価格",
		"FBM発送方式",
		"商品名称",
		"仕入申報価格（元）",
		"仕入申報価格（ドル）",
		"暫定フラグ",
		"店舗ID",
		"登録日時",
		"更新日時"
	) VALUES (
		:productno,--商品管理番号
		:preproduct,--親子区分
		:producttype,--商品種別
		:sub1,--分類１
		:sub2,--分類２
		:price1, --仕入価格
		:fba,--FBM発送方式
		:productname,--商品名称
		:price2,--仕入申報価格（元）
		:price3, --仕入申報価格（ドル）
		'1',--暫定フラグ
		:shopid,--店舗ID
		now(), --登録日時
		now() --更新日時
	)
</sql>
<!-- sl：更新-暂定1-親商品 -->
<sql id="udatemasterinfoflg1pre" paramPrefix="!">
		UPDATE "MST_出品マスタ情報" 
		SET

			"商品管理番号" = !productno,
			"商品種別" = !producttype,

			"商品名称" = !productname,

			"暫定フラグ" = 0,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 	<if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	   <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
		   
</sql>


<!-- sl：更新-暂定1-子商品 -->
<sql id="udatemasterinfoflg1sub1" paramPrefix="!">
		UPDATE "MST_出品マスタ情報" 
		SET

			"商品管理番号" = !productno,
			"商品種別" = !producttype,
			"分類１" = !sub1,
			"分類２" = !sub2,

			"仕入価格" = !price1,
			"仕入申報価格（元）" = !price2,
			"仕入申報価格（ドル）" = !price3,

			"FBM発送方式" = !fba,
			"商品名称" = !productname,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 <if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	   <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
	 	<if exists="oldsub1"> AND (	
		  "分類１" = !oldsub1
		)
	    </if>
	   <if notexists="oldsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="oldsub2"> AND (	
		  "分類２" = !oldsub2
		)
	    </if>
	    <if notexists="oldsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
</sql>
<sql id="udatemasterinfoflg1sub2" paramPrefix="!">
		UPDATE "MST_出品マスタ情報" 
		SET
			"SKU番号" = !sku,
			"ASIN番号" = !asin,
			"LABEL番号" = !label,

			"暫定フラグ" = 0,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 <if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	   <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
	 	<if exists="oldsub1"> AND (	
		  "分類１" = !oldsub1
		)
	    </if>
	   <if notexists="oldsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="oldsub2"> AND (	
		  "分類２" = !oldsub2
		)
	    </if>
	    <if notexists="oldsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
</sql>

<sql id="udateStockflg1sub2" paramPrefix="!">
		UPDATE "MST_在庫情報" 
		SET
			"SKU番号" = !sku,
			"ASIN番号" = !asin,
			"LABEL番号" = !label,

			"暫定フラグ" = 0,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 <if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	   <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
	 	<if exists="oldsub1"> AND (	
		  "分類１" = !oldsub1
		)
	    </if>
	   <if notexists="oldsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="oldsub2"> AND (	
		  "分類２" = !oldsub2
		)
	    </if>
	    <if notexists="oldsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
</sql>

<sql id="udatePurchaseflg1sub2" paramPrefix="!">
		UPDATE "TRN_仕入明細" 
		SET
			"SKU番号" = !sku,
			"ASIN番号" = !asin,
			"LABEL番号" = !label,

			"暫定フラグ" = 0,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 <if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	   <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
	 	<if exists="oldsub1"> AND (	
		  "分類１" = !oldsub1
		)
	    </if>
	   <if notexists="oldsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="oldsub2"> AND (	
		  "分類２" = !oldsub2
		)
	    </if>
	    <if notexists="oldsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
</sql>
<!-- sl：更新-暂定0-親商品 -->
<sql id="udatemasterinfoflg0pre" paramPrefix="!">
		UPDATE "MST_出品マスタ情報" 
		SET
			"商品種別" = !producttype,
			"商品管理番号" = !productno,
			"商品名称" = !productname,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 	<if exists="oldasin"> AND (	
		  "ASIN番号" = !oldasin
		)
	    </if>
	   <if notexists="oldasin"> AND (	
		  "ASIN番号" is NULL
		)
	   </if> 
	 	<if exists="oldsku"> AND (	
		  "SKU番号" = !oldsku
		)
	    </if>
	   <if notexists="oldsku"> AND (	
		  "SKU番号" is NULL
		)
	   </if>
</sql>
<!-- sl：更新-暂定0-子商品 -->
<sql id="udatemasterinfoflg0sub" paramPrefix="!">
	UPDATE "MST_出品マスタ情報" 
		SET
			"商品管理番号" = !productno,
			"商品種別" = !producttype,
			"分類１" = !sub1,
			"分類２" = !sub2,

			"仕入価格" = !price1,
			"仕入申報価格（元）" = !price2,
			"仕入申報価格（ドル）" = !price3,

			"FBM発送方式" = !fba,
			"商品名称" = !productname,
		    "更新日時"=now()
		WHERE 
		    "店舗ID" =!shopid
	 	<if exists="oldasin"> AND (	
		  "ASIN番号" = !oldasin
		)
	    </if>
	   <if notexists="oldasin"> AND (	
		  "ASIN番号" is NULL
		)
	   </if> 
	 	<if exists="oldsku"> AND (	
		  "SKU番号" = !oldsku
		)
	    </if>
	   <if notexists="oldsku"> AND (	
		  "SKU番号" is NULL
		)
	   </if>

</sql>
<!-- sl：更新仕入価格 -->
<sql id="udatemasterinfosubprice1"  >
		UPDATE "MST_出品マスタ情報" 
		SET
		   "仕入価格" =  :price1
		WHERE 
		  "店舗ID" =:shopid
		AND 
		  "商品管理番号" = :no
		AND 
		  "親子区分" = '子商品'
</sql>
<!--sl:更新仕入明细价格  -->
<sql id="udatePurchasesubprice1"  >
		UPDATE "TRN_仕入明細" 
		SET
		   "単価" =  :price1,
		   "更新日時"= now()
		WHERE 
		  "店舗ID" =:shopid
		AND 
		  "商品管理番号" = :no
		AND 
		  "親子区分" = '子商品'
</sql>
<sql id="udatePurchasesubprice2"  >
		UPDATE "TRN_仕入明細" 
		SET
		   "単価" =  :price1,
		   "更新日時"= now()
		WHERE 
		  "店舗ID" =:shopid
		  	 <if exists="oldno"> AND (	
		  "商品管理番号" = !oldno
		)
	    </if>
	   <if notexists="oldno"> AND (	
		  "商品管理番号" is NULL
		)
	   </if> 
	 	<if exists="oldpreproduct"> AND (	
		  "親子区分" = !oldpreproduct
		)
	    </if>
	   <if notexists="oldpreproduct"> AND (	
		  "親子区分" is NULL
		)
	   </if>
	 	<if exists="oldtype"> AND (	
		  "商品種別" = !oldtype
		)
	    </if>
	   <if notexists="oldtype"> AND (	
		  "商品種別" is NULL
		)
	   </if>
	 	<if exists="oldsub1"> AND (	
		  "分類１" = !oldsub1
		)
	    </if>
	   <if notexists="oldsub1"> AND (	
		  "分類１" is NULL
		)
	   </if>
	    <if exists="oldsub2"> AND (	
		  "分類２" = !oldsub2
		)
	    </if>
	    <if notexists="oldsub2"> AND (	
		  "分類２" is NULL
		)
	     </if>
</sql>
<sql id="udatemasterinfosubprice2"  >
		UPDATE "MST_出品マスタ情報" 
		SET
			"仕入申報価格（元）" = :price2
		WHERE 
		  "店舗ID" =:shopid
		AND 
		  "商品管理番号" = :no
		AND 
		  "親子区分" = '子商品'
</sql>
<sql id="udatemasterinfosubprice3"  >
		UPDATE "MST_出品マスタ情報" 
		SET
			"仕入申報価格（ドル）" = :price3
		WHERE 
		  "店舗ID" =:shopid
		AND 
		  "商品管理番号" = :no
		AND 
		  "親子区分" = '子商品'
</sql>
<sql id="udatemasterinfosubfba"  >
		UPDATE "MST_出品マスタ情報" 
		SET
			"FBM発送方式" = :fba
		WHERE 
		  "店舗ID" =:shopid
		AND 
		  "商品管理番号" = :no
		AND 
		  "親子区分" = '子商品'
</sql>

<sql id="searchAsinSku" >
	SELECT 
	      "ASIN番号" as asin
		, "SKU番号" as sku
		 
	FROM
		"MST_出品マスタ情報" 
	WHERE
		"暫定フラグ" = 0
		and
		(
			"商品管理番号" = :productno
			or
			"商品管理番号" is null
		)
		and
		"店舗ID" =:shopid
	</sql>
	<sql id="selectAsinSku" >
		SELECT 
			"ASIN番号" as asin
			, "SKU番号" as sku
			, "LABEL番号" as label
		FROM
			"MST_出品マスタ情報" 
		WHERE
			"暫定フラグ" = 0
			and
			"ASIN番号" = :asin
			and
			"SKU番号" = :sku
			and
			"店舗ID" =:shopid
	</sql>
	<sql id="deleteByAsinSku" >
		DELETE FROM "MST_出品マスタ情報" 
		WHERE
			"暫定フラグ" = 0
			and
			"ASIN番号" = :asin
			and
			"SKU番号" = :sku
			and
			"店舗ID" =:shopid
	</sql>

	<sql id="deleteByAsinSkuForStock" >
		DELETE FROM "MST_在庫情報" 
		WHERE
			"暫定フラグ" = 0
			and
			"ASIN番号" = :asin
			and
			"SKU番号" = :sku
			and
			"店舗ID" =:shopid
	</sql>

	
	<sql id="deleteByAsinSkuForPurchase" >
		DELETE FROM "TRN_仕入明細" 
		WHERE
			"暫定フラグ" = 0
			and
			"ASIN番号" = :asin
			and
			"SKU番号" = :sku
			and
			"店舗ID" =:shopid
	</sql>
<!-- sl:删除マスタ -->
		<sql id="deletemasterinfo" >
		DELETE FROM "MST_出品マスタ情報" 
		WHERE
			"商品管理番号" = :oldno
			and
			"親子区分" = :oldpreproduct
			and
			"商品種別" = :oldtype
			and
			"分類１" = :oldsub1
			and
			"分類２" = :oldsub2
			and
			"店舗ID" =:shopid
	</sql>
</sqls>

